"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2020.10.6"
__checksum__ = "65b01a7f20287768550f69857058e80bec61d32671bc50dbc63e6093f30e363d"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), None, (16, 57), (73, 26), (99, 12), None, (111, 19), (130, 22), (152, 7), (159, 20), (179, 18), None, (197, 22), (219, 45), (264, 7), (271, 9), (280, 36), (316, 10), (326, 10), (336, 21), None, (357, 50), (407, 8), (415, 9), (424, 19), (443, 13), (456, 14), (470, 14), None, None, (484, 29), (513, 16), (529, 35), (564, 14), (578, 24), (602, 9), None, (611, 25), (636, 20), (656, 8), (664, 13), (677, 10), None, (687, 17), (704, 6), (710, 26), (736, 5), (741, 5), (746, 10), (756, 10), (766, 11), (777, 12), (789, 27), None, (816, 11), (827, 11), (838, 7), (845, 29), (874, 18), (892, 27), (919, 46), (965, 25), (990, 16), (1006, 8), (1014, 5), (1019, 22), (1041, 18), None, (1059, 36), (1095, 15), (1110, 8), (1118, 11), None, (1129, 5), (1134, 16), (1150, 14), (1164, 18), None, (1182, 14), (1196, 26), (1222, 48), (1270, 19), (1289, 5), (1294, 46), (1340, 14), (1354, 14), (1368, 20), None, (1388, 10), (1398, 13), (1411, 10), (1421, 19), None, (1440, 13), (1453, 19), (1472, 5), (1477, 4), (1481, 22), (1503, 10), (1513, 7), (1520, 14), (1534, 21), (1555, 11), (1566, 10), (1576, 12), (1588, 32), None, (1620, 10), (1630, 14), (1644, 12), (1656, 45), (1701, 15), None, (1716, 11), (1727, 23), (1750, 21), (1771, 26), (1797, 6), (1803, 6), (1809, 7), (1816, 5), (1821, 20), (1841, 23), (1864, 24), (1888, 13), (1901, 15), (1916, 19), (1935, 6), (1941, 61), (2002, 44), (2046, 12), (2058, 23), (2081, 16), (2097, 38), (2135, 6), (2141, 12), (2153, 44), (2197, 6), (2203, 41), (2244, 13), (2257, 23), (2280, 30), (2310, 16), (2326, 8), (2334, 15), (2349, 12), (2361, 19), (2380, 21), (2401, 15), None, (2416, 35), (2451, 21), (2472, 17), (2489, 19), (2508, 26), (2534, 5), (2539, 37), (2576, 26), (2602, 16), (2618, 10), (2628, 17), (2645, 23), (2668, 14), (2682, 17), (2699, 8), (2707, 4), (2711, 7), (2718, 29), (2747, 6), (2753, 18), (2771, 27), (2798, 20), (2818, 17), (2835, 19), (2854, 12), (2866, 40), (2906, 40), (2946, 12), (2958, 48), (3006, 25), (3031, 12), None, (3043, 8), (3051, 20), (3071, 19), (3090, 6), (3096, 23), None, (3119, 30), (3149, 33), (3182, 14), (3196, 12), (3208, 27), None, (3235, 26), (3261, 41), (3302, 50), (3352, 15), (3367, 20), (3387, 15), (3402, 21), (3423, 32), (3455, 24), (3479, 20), (3499, 13), (3512, 60), (3572, 19), (3591, 9), (3600, 12), (3612, 12), (3624, 11), (3635, 10), (3645, 48), (3693, 32), None, (3725, 25), (3750, 12), None, (3762, 8), (3770, 8), (3778, 7), None, (3785, 25), (3810, 17), None, (3827, 21), (3848, 35), (3883, 12), (3895, 10), (3905, 36), (3941, 20), (3961, 22), (3983, 23), (4006, 19), (4025, 12), (4037, 5), (4042, 30), (4072, 24), (4096, 14), (4110, 14), (4124, 47), (4171, 46), None, None, (4217, 51), (4268, 42), None, (4310, 14), None, (4324, 15), (4339, 8), (4347, 21), (4368, 6), (4374, 16), (4390, 17)], [(4407, 6412), (10819, 6940), (17759, 7213), (24972, 6155), (31127, 6499), (37626, 6221), (43847, 7088), (50935, 6418), (57353, 7002), (64355, 6229), (70584, 7346), (77930, 6599), (84529, 6859), (91388, 7321), (98709, 6608), (105317, 6902), (112219, 7208), (119427, 6088), (125515, 6338), (131853, 6656), (138509, 7061), (145570, 6664), (152234, 7122), (159356, 6292), (165648, 6527), (172175, 6771), (178946, 6880), (185826, 7097), (192923, 6348), (199271, 6900), (206171, 6977), (213148, 6616), (219764, 6658), (226422, 7146), (233568, 6328), (239896, 6928), (246824, 6359), (253183, 7209), (260392, 6935), (267327, 7034), (274361, 7679), (282040, 6544), (288584, 6519), (295103, 6287), (301390, 6456), (307846, 6332), (314178, 6557), (320735, 7160), (327895, 6491), (334386, 6050), (340436, 6534), (346970, 6760), (353730, 6801), (360531, 6900), (367431, 7032), (374463, 6934), (381397, 6988), (388385, 6167), (394552, 7050), (401602, 5952), (407554, 6768), (414322, 6574), (420896, 6511), (427407, 6990), (434397, 6752), (441149, 6832), (447981, 6381), (454362, 7244), (461606, 6919), (468525, 6912), (475437, 6618), (482055, 6664), (488719, 5781), (494500, 7094), (501594, 7149), (508743, 7253), (515996, 6147), (522143, 7330), (529473, 7147), (536620, 6235), (542855, 6985), (549840, 5925), (555765, 6621), (562386, 6827), (569213, 6573), (575786, 6521), (582307, 6856), (589163, 6816), (595979, 7004), (602983, 6841), (609824, 7440), (617264, 6123), (623387, 6428), (629815, 6692), (636507, 6627), (643134, 7234), (650368, 7228), (657596, 6536), (664132, 6407), (670539, 6354), (676893, 6400), (683293, 6818), (690111, 6315), (696426, 6633), (703059, 6332), (709391, 6981), (716372, 6880), (723252, 7227), (730479, 8241), (738720, 7271), (745991, 7146), (753137, 6741), (759878, 6492), (766370, 6786), (773156, 7072), (780228, 6877), (787105, 6297), (793402, 6513), (799915, 6463), (806378, 7311), (813689, 7136), (820825, 7150), (827975, 7098), (835073, 7130), (842203, 7942), (850145, 6519), (856664, 5970), (862634, 7047), (869681, 6671), (876352, 8286), (884638, 7294), (891932, 6212), (898144, 6934), (905078, 6965), (912043, 6420), (918463, 6910), (925373, 6261), (931634, 6802), (938436, 6574), (945010, 6702), (951712, 6827), (958539, 7388), (965927, 6395), (972322, 6421), (978743, 6818), (985561, 6689), (992250, 6710), (998960, 7016), (1005976, 6385), (1012361, 7292), (1019653, 6733), (1026386, 6866), (1033252, 7141), (1040393, 6579), (1046972, 6831), (1053803, 6781), (1060584, 6558), (1067142, 6634), (1073776, 6394), (1080170, 6160), (1086330, 6403), (1092733, 6811), (1099544, 7368), (1106912, 6271), (1113183, 6662), (1119845, 7065), (1126910, 6404), (1133314, 6433), (1139747, 7100), (1146847, 6660), (1153507, 6068), (1159575, 6709), (1166284, 7867), (1174151, 6261), (1180412, 6457), (1186869, 6978), (1193847, 6543), (1200390, 6822), (1207212, 6620), (1213832, 6171), (1220003, 7682), (1227685, 6896), (1234581, 6708), (1241289, 7109), (1248398, 7557), (1255955, 7453), (1263408, 6240), (1269648, 7224), (1276872, 6441), (1283313, 6693), (1290006, 6986), (1296992, 6439), (1303431, 7016), (1310447, 7204), (1317651, 6708), (1324359, 6800), (1331159, 6600), (1337759, 6597), (1344356, 6905), (1351261, 6482), (1357743, 6909), (1364652, 6182), (1370834, 7162), (1377996, 7012), (1385008, 6705), (1391713, 7235), (1398948, 5930), (1404878, 6863), (1411741, 6687), (1418428, 7009), (1425437, 6952), (1432389, 7230), (1439619, 6835), (1446454, 7033), (1453487, 7004), (1460491, 6532), (1467023, 6732), (1473755, 6773), (1480528, 6810), (1487338, 6555), (1493893, 6712), (1500605, 6191), (1506796, 7729), (1514525, 6854), (1521379, 6432), (1527811, 6756), (1534567, 6846), (1541413, 6131), (1547544, 6980), (1554524, 6644), (1561168, 7674), (1568842, 6583), (1575425, 6174), (1581599, 7146), (1588745, 6510), (1595255, 7330), (1602585, 6345), (1608930, 6461), (1615391, 5901), (1621292, 6870), (1628162, 6638), (1634800, 6977), (1641777, 6506), (1648283, 6758), (1655041, 6618), (1661659, 7251), (1668910, 6538), (1675448, 5975), (1681423, 6733), (1688156, 6460), (1694616, 6886), (1701502, 7176), (1708678, 7188), (1715866, 6365), (1722231, 6390), (1728621, 6803)], [(1735424, 716), (1736140, 669), (1736809, 665), (1737474, 757), (1738231, 564), (1738795, 670), (1739465, 698), (1740163, 836), (1740999, 640), (1741639, 667), (1742306, 536), (1742842, 626), (1743468, 792), (1744260, 853), (1745113, 1020), (1746133, 868), (1747001, 1242), (1748243, 669), (1748912, 918), (1749830, 696), (1750526, 757), (1751283, 765), (1752048, 865), (1752913, 731), (1753644, 717), (1754361, 715), (1755076, 955), (1756031, 1146), (1757177, 807), (1757984, 748), (1758732, 922), (1759654, 818), (1760472, 586), (1761058, 733), (1761791, 760), (1762551, 800), (1763351, 678), (1764029, 746), (1764775, 724), (1765499, 1119), (1766618, 695), (1767313, 812), (1768125, 748), (1768873, 719), (1769592, 728), (1770320, 420), (1770740, 942), (1771682, 870), (1772552, 746), (1773298, 592), (1773890, 834), (1774724, 692), (1775416, 780), (1776196, 1012), (1777208, 944), (1778152, 558), (1778710, 681), (1779391, 569), (1779960, 607), (1780567, 771), (1781338, 772), (1782110, 796), (1782906, 1054), (1783960, 927), (1784887, 725), (1785612, 719), (1786331, 767), (1787098, 494), (1787592, 595), (1788187, 592), (1788779, 692), (1789471, 877), (1790348, 613), (1790961, 725), (1791686, 650), (1792336, 685), (1793021, 573), (1793594, 711), (1794305, 808), (1795113, 496), (1795609, 814), (1796423, 629), (1797052, 828), (1797880, 646), (1798526, 619), (1799145, 439), (1799584, 597), (1800181, 746), (1800927, 804), (1801731, 782), (1802513, 869), (1803382, 1092), (1804474, 839), (1805313, 856), (1806169, 725), (1806894, 436), (1807330, 955), (1808285, 857), (1809142, 580), (1809722, 671), (1810393, 728), (1811121, 885), (1812006, 903), (1812909, 571), (1813480, 632), (1814112, 772), (1814884, 419), (1815303, 466), (1815769, 953), (1816722, 963), (1817685, 851), (1818536, 793), (1819329, 632), (1819961, 792), (1820753, 672), (1821425, 699), (1822124, 709), (1822833, 525), (1823358, 722), (1824080, 710), (1824790, 930), (1825720, 700), (1826420, 804), (1827224, 483), (1827707, 691), (1828398, 780), (1829178, 835), (1830013, 926), (1830939, 806), (1831745, 942), (1832687, 802), (1833489, 524), (1834013, 815), (1834828, 651), (1835479, 803), (1836282, 794), (1837076, 737), (1837813, 681), (1838494, 677), (1839171, 673), (1839844, 621), (1840465, 674), (1841139, 694), (1841833, 648), (1842481, 494), (1842975, 603), (1843578, 661), (1844239, 597), (1844836, 729), (1845565, 594), (1846159, 773), (1846932, 514), (1847446, 550), (1847996, 701), (1848697, 642), (1849339, 657), (1849996, 639), (1850635, 870), (1851505, 634), (1852139, 622), (1852761, 903), (1853664, 870), (1854534, 583), (1855117, 695), (1855812, 873), (1856685, 659), (1857344, 692), (1858036, 455), (1858491, 628), (1859119, 681), (1859800, 810), (1860610, 654), (1861264, 932), (1862196, 760), (1862956, 807), (1863763, 721), (1864484, 668), (1865152, 582), (1865734, 683), (1866417, 706), (1867123, 1412), (1868535, 575), (1869110, 662), (1869772, 650), (1870422, 1027), (1871449, 800), (1872249, 798), (1873047, 567), (1873614, 609), (1874223, 823), (1875046, 601), (1875647, 589), (1876236, 814), (1877050, 737), (1877787, 892), (1878679, 810), (1879489, 764), (1880253, 710), (1880963, 868), (1881831, 637), (1882468, 947), (1883415, 662), (1884077, 819), (1884896, 630), (1885526, 742), (1886268, 510), (1886778, 828), (1887606, 843), (1888449, 665), (1889114, 916), (1890030, 787), (1890817, 868), (1891685, 954), (1892639, 1077), (1893716, 887), (1894603, 669), (1895272, 917), (1896189, 731), (1896920, 533), (1897453, 443), (1897896, 794), (1898690, 823), (1899513, 455), (1899968, 1028), (1900996, 513), (1901509, 798), (1902307, 881), (1903188, 792), (1903980, 806), (1904786, 696), (1905482, 826), (1906308, 751), (1907059, 784), (1907843, 607), (1908450, 579), (1909029, 445), (1909474, 666), (1910140, 484), (1910624, 816), (1911440, 880), (1912320, 764), (1913084, 718), (1913802, 658), (1914460, 604), (1915064, 866), (1915930, 495), (1916425, 606), (1917031, 780), (1917811, 494), (1918305, 870), (1919175, 2112), (1921287, 565), (1921852, 705), (1922557, 890), (1923447, 943), (1924390, 539)], [(1924929, 48), None, (1924977, 35), (1925012, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (1925054, 42), None, (1925096, 25), (1925121, 44), (1925165, 22), (1925187, 18), None, None, None, None, (1925205, 26), None, None, None, None, (1925231, 21), (1925252, 25), None, None, (1925277, 26), None, None, None, None, (1925303, 44), (1925347, 21), (1925368, 23), None, None, None, None, (1925391, 48), None, None, None, None, None, (1925439, 31), None, None, None, None, (1925470, 42), None, (1925512, 22), None, (1925534, 21), None, (1925555, 26), (1925581, 42), None, None, (1925623, 77), None, None, None, None, None, (1925700, 21), (1925721, 21), None, None, (1925742, 34), (1925776, 42), None, None, None, (1925818, 25), None, None, (1925843, 21), None, None, None, None, None, (1925864, 24), (1925888, 21), None, None, (1925909, 26), None, (1925935, 18), None, (1925953, 54), None, None, None, None, None, None, (1926007, 26), None, (1926033, 19), None, (1926052, 20), None, None, (1926072, 42), (1926114, 42), (1926156, 17), (1926173, 17), (1926190, 26), None, (1926216, 26), None, None, None, (1926242, 26), (1926268, 20), (1926288, 26), None, (1926314, 42), (1926356, 63), None, None, None, (1926419, 40), (1926459, 48), None, None, None, (1926507, 47), None, None, None, None, None, None, None, (1926554, 42), None, (1926596, 55), None, (1926651, 9), None, (1926660, 21), (1926681, 42), None, None, (1926723, 65), (1926788, 82), None, None, (1926870, 42), None, None, None, None, None, None, None, None, None, (1926912, 42), (1926954, 21), (1926975, 21), None, (1926996, 42), (1927038, 25), None, (1927063, 16), (1927079, 21), (1927100, 42), None, None, (1927142, 21), (1927163, 19), (1927182, 26), None, None, None, (1927208, 39), None, None, (1927247, 38), None, (1927285, 22), (1927307, 21), (1927328, 21), None, None, (1927349, 63), None, (1927412, 21), (1927433, 42), None, (1927475, 17), None, None, None, None, (1927492, 21), (1927513, 21), None, None, (1927534, 21), None, None, (1927555, 21), None, (1927576, 26), None, (1927602, 50), None, None, None, (1927652, 50), (1927702, 26), (1927728, 21), (1927749, 21), (1927770, 19), None, (1927789, 35), (1927824, 26), (1927850, 23), (1927873, 21), (1927894, 42), None, None, None, None, None, None, (1927936, 21), None, None, None, (1927957, 21), None, None, (1927978, 90), None, (1928068, 239), (1928307, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
